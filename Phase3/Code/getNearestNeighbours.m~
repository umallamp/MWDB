function [ output_args ] = getNearestNeighbours( vectorApproxIndex, queryWordFile, neighbourCount, totalFileCount, features, colIndexVector, reducedFeatures, minValues, maxValues, bitsPerDims, boundaries, dataSetRegions )

% represents query as vector by counting the number of unique words
queryVector = zeros(1, length(features));

% get query vector
for featureId = 1 : length(features)
    queryVector(featureId) = sum(ismember(queryWordFile(:, colIndexVector), features(featureId, :),'rows'));
end

% get reduced query vector and regions for dimensions
reducedQueryVector = queryVector * reducedFeatures';
queryRegions = getRegions(reducedQueryVector, minValues, maxValues, bitsPerDims);

% initialize variables for query processing
global neighbours;
neighbours(neighbourCount, 1) = zeros(neighbourCount, 1);
neighbours(neighbourCount, 2) = Inf(neighbourCount, 1);

lowerBounds = zeros(neighbourCount);
upperBounds = zeros(neighbourCount);

distance = Inf;

for fileId = 1 : totalFileCount
    [lowerBounds(fileId), upperBounds(fileId)] = getBounds(queryVector, queryRegions, boundaries, dataSetRegions);
    if(lowerBounds(fileId) < distance)
        distance = insertCandidate(upperBounds(fileId), fileId, neighbourCount);
    end
end
end

function [ maxDistance ] = insertCandidate(distance, fileId, neighbourCount)
    if(distance < neighbours(neighbourCount, 2))
        % insert the candidate and the distance
        neighbours(neighbourCount, 1) = fileId;
        neighbours(neighbourCount, 2) = distance;

        % sort neighbours based on distance
        [~, order] = sort(neighbours(:,1));
        neighbours = neighbours(order, :);
    end
    maxDistance = neighbours(neighbourCount, 2);
end


function [ lowerBound, upperBound] = getBounds(queryVector, queryRegions, boundaries, dataSetRegions)

lowerBound = 0;
upperBound = 0;

for dimId = 1 : length(queryVector)
    % L2 metric for calculating lower bound and upper bound
    % if data point lies left of query point
    if(dataSetRegions(dimId) < queryRegions(dimId))
        lowerBound = lowerBound + (queryVector(dimId) - boundaries(dataSetRegions(dimId) + 1))^2;
        upperBound = upperBound + (queryVector(dimId) - boundaries(dataSetRegions(dimId)))^2;
    end
    % if data point lies in the same region
    if(dataSetRegions(dimId) == queryRegions(dimId))
        lowerBound = lowerBound + 0;
        upperBound = upperBound + max((queryVector(dimId) - boundaries(dataSetRegions(dimId))), (boundaries(dataSetRegions(dimId) + 1) - queryVector(dimId)))^2;
    end
    % if data point lies in the right region
    if(dataSetRegions(dimId) > queryRegions(dimId))
        lowerBound = lowerBound + (boundaries(dataSetRegions(dimId) - queryVector(dimId)))^2;
        upperBound = upperBound + (boundaries(dataSetRegions(dimId) + 1) - queryVector(dimId))^2;
    end
end

lowerBound = sqrt(lowerBound);
upperBound = sqrt(upperBound);

end
